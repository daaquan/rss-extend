#!/usr/bin/env php
<?php
chdir(dirname(__DIR__));
ini_set('max_execution_time', 300);
require 'init_autoloader.php';
$application = Zend\Mvc\Application::init(require 'config/application.config.php');

$collection = $application->getServiceManager()->get('RssExtend\Feed\Collection');

foreach ($collection as $feed) {

    echo 'Updating Feed ' . $feed->getId();

    /* @var \Zend\Cache\Storage\Adapter\Filesystem $cache */
    $cache = $application->getServiceManager()->get('Zend\Cache\Storage\Adapter\Filesystem');

    $downloader = $feed->getParser()->getDownloader();
    $downloader->setCache($cache);
    $downloader->setSleep(1000000, 10000000); // 1 - 10 sec

    try {
        $entries = $feed->getUpdatedFeed();
        echo ' ... success.' . PHP_EOL;
    } catch (\Exception $e) {
        echo ' ... failure: ' . $e->getMessage() . '.' . PHP_EOL;
    }
}

exit(0);