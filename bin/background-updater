#!/usr/bin/env php
<?php
chdir(dirname(__DIR__));
ini_set('max_execution_time', 300);

require 'init_autoloader.php';
$application = Zend\Mvc\Application::init(require 'config/application.config.php');

$youtube = $application->getServiceManager()->get('RssExtend\Youtube');
$youtube->clearExpired();

$collection = $application->getServiceManager()->get('RssExtend\Feed\Collection');

foreach ($collection as $feed) {

    echo 'Updating Feed ' . $feed->getId();

    /* @var \Zend\Cache\Storage\Adapter\Filesystem $cache */
    $cache = $application->getServiceManager()->get('Zend\Cache\Storage\Adapter\Filesystem');
    $cache->clearExpired();

    $downloader = $feed->getParser()->getDownloader();
    $downloader->setCache($cache);
    $downloader->setSleep(500000, 2000000); // 0.5 - 5 sec

    try {
        $entries = $feed->getUpdatedFeed();
        echo ' ... success.' . PHP_EOL;
    } catch (\Exception $e) {
        echo ' ... failure: ' . $e->getMessage() . '.' . PHP_EOL;
    }
}



exit(0);